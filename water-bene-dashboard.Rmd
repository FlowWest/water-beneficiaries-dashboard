---
title: "Water Beneficiaries Dashboard"
output: 
  flexdashboard::flex_dashboard:
   theme: readable
   font_family: "Roboto"
   google_fonts: true
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(tidyverse)
library(sf)
library(DT)
```

```{r}
# read in processed data
nf_boundaries <- readRDS(here::here("data", "nf_boundaries.RDS"))
watersheds <- readRDS(here::here("data", "watersheds.RDS"))
hydropower <- readRDS(here::here("data", "hydropower.RDS")) #TODO: placeholder

all_datasets <- readRDS(here::here("data", "all_datasets.RDS"))
```

```{r}
filter_by_metric <- function(data, column, metric) {
  if (metric == "None") {
    return(data)
  } else if (metric == "Top 10%") {
    return(data |>  slice_max(order_by = {{ column }}, prop = 0.10))
  } else if (metric == "Top 25%") {
    return(data |>  slice_max(order_by = {{ column }}, prop = 0.25))
  } else {
    warning("Unrecognized metric. Returning all data.")
    return(data)
  }
  
}
```

Inputs {.sidebar}
-----------------------------------------------------------------------
```{r}

radioButtons(
  inputId = "select_huc_or_nf",
  label = tags$strong("filter by watershed or national forest?"),
  choices = c("Watershed (HUC6)", "National Forest"),
  selected = "National Forest"
)

conditionalPanel(
  condition = "input.select_huc_or_nf == 'Watershed (HUC6)'",
  selectInput(
    inputId = 'select_huc',
    label = tags$strong('Select watershed to identify connected benficiaries'),
    choices = c(unique(watersheds$name)),
    selected = "Upper Sacramento" # TODO: placeholder
  )
)

conditionalPanel(
  condition = "input.select_huc_or_nf == 'National Forest'",
  selectInput(
    inputId = 'select_nf',
    label = tags$strong('Select National Forest to identify connected benficiaries'),
    choices = c(unique(nf_boundaries$name)),
    selected = "Klamath National Forest"
  )
)

selectInput(
  inputId = "select_bene",
  label = tags$strong("Select type of beneficiary"),
  choices = c("Water right owner" = "water_right",
              "CVP contractor" = "cvp",
              "SWP contractor" = "swp",
              "Public water system" = "pws",
              "Hydropower facility" = "hydropower",
              "Agricultural landowner" = "ag",
              "Business owner" = "business"),
  selected = "hydropower"
)

radioButtons(
  inputId = "select_metric",
  label = tags$strong("Select a metric to filter beneficiaries"),
  choices = c("None", "Top 10%", "Top 25%")
)

```

Row {.tabset}
-----------------------------------------------------------------------

### Map

```{r}
boundary <- reactive({
  if(input$select_huc_or_nf == "National Forest") {
    print("national forest")
    return(nf_boundaries |> filter(name == input$select_nf))
  } else {
    print("huc")
    return(watersheds |> filter(name == input$select_huc))
  }
})

```

```{r}
output$map <- renderLeaflet({
  leaflet() |> 
    addTiles() |> 
    setView(lng = -122.5, lat = 39, zoom = 7)
})
```

```{r}
filtered_dataset <- reactive({
  req(input$select_bene)
  
  all_datasets |> 
    filter(beneficiary_type == case_when(
      input$select_bene == "hydropower" ~ "hydropower facility",
      input$select_bene == "cvp" ~ "cvp contractor",
      input$select_bene == "swp" ~ "swp contractor",
      # input$select_bene == "pws" ~ "Public water system",
      TRUE ~ NA_character_  # fallback
    ))
})


```

```{r}
# change based off of selected dataset
observe({ 
  req(input$select_bene, input$select_metric)
  
  tmp_data <- filtered_dataset() |> 
  filter_by_metric(quantity_metric, input$select_metric) |> 
  st_transform(4326)
  
  # Universal popup for all beneficiary types
  popup_content <- ~paste(
    "<strong>Entity Name:</strong>", entity_name, "<br>",
    "<strong>Address:</strong>", entity_address, "<br>",
    "<strong>Quantity:</strong>", quantity_metric, quantity_unit
  )
  
  # Geometry check
  is_polygon <- st_geometry_type(tmp_data) %in% c("POLYGON", "MULTIPOLYGON")
  polygons <- tmp_data[is_polygon, ]
  points <- tmp_data[!is_polygon, ]
  
  # Clear and add layers
  leafletProxy("map") |> 
    clearMarkers() |> 
    clearShapes() |> 
    addPolygons(data = boundary(), popup = ~name)
  
  if (nrow(polygons) > 0) {
    leafletProxy("map") |> 
      addPolygons(data = polygons,
                  weight = 1,
                  color = "brown",
                  fillOpacity = 0.2,
                  popup = popup_content)
  }
  
  if (nrow(points) > 0) {
    leafletProxy("map") |> 
      addCircleMarkers(data = points,
                       lng = ~longitude, 
                       lat = ~latitude,
                       opacity = 1, 
                       fillOpacity = 0.8, 
                       radius = 2,
                       popup = popup_content)
  }
})


leafletOutput("map", height = "600px")


```

### Catalog 

```{r}
DTOutput("catalog")
```

```{r}
output$catalog <- renderDT({
  datatable(
    all_datasets |> 
      select(-c(latitude, longitude)) |> 
      st_drop_geometry(), 
    options = list(
      pageLength = 10,
      searching = TRUE,
      ordering = TRUE
    )
  )
})


```

### Summary
